name: üèóÔ∏è E2E Tests (Cypress)

on:
  push:
    branches:
      - main
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:

  install:
    runs-on: ubuntu-latest

    outputs:
      record: ${{ steps.should-we-record.outputs.record }}

    steps:
      - name: üë∑‚Äç‚ôÄÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üé• Should we record?
        run: echo '::set-output name=record::${{  env.CYPRESS_PROJECT_ID != '' }}'
        id: should-we-record
        
      - name: üë©‚Äçüè≠ Cypress install
        uses: cypress-io/github-action@v2
        with:
          runTests: false
          build: yarn build
          record: true
          command-prefix: yarn dlx
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üíæ Save build folder
        uses: actions/upload-artifact@v2
        with:
          name: dist
          if-no-files-found: error
          path: dist
          
  test-on-firefox:
    needs: install
    runs-on: ubuntu-latest
    container:
      image: cypress/included:9.7.0
      options: --user 1001

    services:
      kaoto:
        image: kaotoio/backend:nightly
        ports:
        # will assign a random free host port
          - 8081/tcp
    steps:
      - name: üë∑‚Äç‚ôÄÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üóÑÔ∏è Download the build folders
        uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist

      - name: ü§ì Set KAOTO_API
        run: echo "KAOTO_API=http://kaoto:8081" > .env
        
        
      - name: ü§ì Start the website
        run: yarn start &
        
      - name: Wait for website to be up
        uses: iFaxity/wait-on-action@v1
        with:
          resource: http://localhost:1337

      - name: üî® Cypress run
        run: yarn e2e:headless

      - name: üíæ Save videos
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: videos-firefox
          path: cypress/videos

      - name: üíæ Save screenshots
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: screenshots-firefox
          path: cypress/screenshots

  test-on-chrome:
    needs: install
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node16.14.2-slim-chrome100-ff99-edge

    services:
      kaoto:
        image: kaotoio/backend:nightly
        ports:
        # will assign a random free host port
          - 8081/tcp
    steps:
      - name: üë∑‚Äç‚ôÄÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üóÑÔ∏è Download the build folders
        uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist

      - name: ü§ì Set KAOTO_API
        run: echo "KAOTO_API=http://kaoto:8081" > .env

      - name: Checks
        run: pwd && ls && find . -name "cypress.json"

      - name: Hate you Cypress
        run: chmod 777 cypress.json

      - name: üî® Cypress run
        uses: cypress-io/github-action@v2.7.0
        with:
          browser: chrome
          build: yarn build
          command-prefix: yarn dlx
          start: yarn start 
          install: false
          tag: ${{ github.event_name }}
          record: ${{needs.install.outputs.record}}
          wait-on: 'http://localhost:1337'
          wait-on-timeout: 120
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üíæ Save videos
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: videos-chrome
          path: cypress/videos

      - name: üíæ Save screenshots
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: screenshots-chrome
          path: cypress/screenshots
          
  test-on-edge:
    needs: install
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node16.14.2-slim-chrome100-ff99-edge
      options: --user 1001

    services:
      kaoto:
        image: kaotoio/backend:nightly
        ports:
        # will assign a random free host port
          - 8081/tcp
    steps:
      - name: üë∑‚Äç‚ôÄÔ∏è Checkout
        uses: actions/checkout@v3

      - name: üóÑÔ∏è Download the build folders
        uses: actions/download-artifact@v2
        with:
          name: dist
          path: dist

      - name: ü§ì Set KAOTO_API
        run: echo "KAOTO_API=http://kaoto:8081" > .env

      - name: Checks
        run: pwd && ls && find . -name "cypress.json"
        
      - name: üë©‚Äçüè≠ Cypress install
        uses: cypress-io/github-action@v2.7.0
        with:
          runTests: false
          build: yarn build
          record: ${{needs.install.outputs.record}}
          command-prefix: yarn dlx
          working-directory: .
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checks
        run: pwd && ls && find . -name "cypress.json"
        
        
      - name: ü§ì Start the website
        run: yarn start &
        
      - name: Wait for website to be up
        uses: iFaxity/wait-on-action@v1
        with:
          resource: http://localhost:1337

      - name: Cypress run
        uses: cypress-io/github-action@v2.7.0 # lock version
        with:
          command: npx yarn dlx cypress@v9 run --headless --config baseUrl=PATH,retries=2 --config-file cypress.json
          install-command: yarn install --immutable
          browser: edge
          install: true
          tag: ${{ github.event_name }}
          record: ${{needs.install.outputs.record}}
          wait-on: 'http://localhost:1337'
          wait-on-timeout: 120
        env:
          CYPRESS_PROJECT_ID: ${{ secrets.CYPRESS_PROJECT_ID }}
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üíæ Save videos
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: videos-edge
          path: cypress/videos

      - name: üíæ Save screenshots
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: screenshots-edge
          path: cypress/screenshots
